import os
import json
import googlemaps
from openai import OpenAI
from dotenv import load_dotenv

# .env í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
load_dotenv()
api_key = os.getenv("AI_API_KEY")
google_maps_key = os.getenv("GOOGLE_API_KEY")

client = OpenAI(api_key=api_key)
gmaps = googlemaps.Client(key=google_maps_key)


# â›³ ì¢Œí‘œ ë³´ì™„ í•¨ìˆ˜
def get_coordinates(place_name):
    try:
        geocode_result = gmaps.geocode(place_name)
        if geocode_result and len(geocode_result) > 0:
            location = geocode_result[0]["geometry"]["location"]
            return location["lat"], location["lng"]
    except Exception as e:
        print(f"[ì¢Œí‘œ ë³€í™˜ ì˜¤ë¥˜] {place_name}: {e}")

    print(f"[âš ï¸ ê¸°ë³¸ ì¢Œí‘œ ì‚¬ìš©] {place_name}")
    return 48.8566, 2.3522  # íŒŒë¦¬ ì¤‘ì‹¬ ì¢Œí‘œ ê¸°ë³¸ê°’
    """ return None, None """


# âœ¨ í•µì‹¬ ì—¬í–‰ ì¼ì • ìƒì„± í•¨ìˆ˜
def generate_travel_plan(city_or_country, days, people, style=None):
    if style:
        prompt = f"{people}ëª…ì´ {days}ì¼ ë™ì•ˆ {city_or_country}ë¡œ ì—¬í–‰ì„ ê°ˆ ì˜ˆì •ì´ì•¼.\nì—¬í–‰ í…Œë§ˆëŠ” {style}ì•¼."
    else:
        prompt = f"{people}ëª…ì´ {days}ì¼ ë™ì•ˆ {city_or_country}ë¡œ ì—¬í–‰ì„ ê°ˆ ì˜ˆì •ì´ì•¼.\ní…Œë§ˆëŠ” ë„¤ê°€ ì¶”ì²œí•´ì¤˜."

    prompt += f"""
    
ì•„ë˜ í˜•ì‹ì²˜ëŸ¼ 'activities' ë°°ì—´ì„ í¬í•¨í•œ JSON í˜•íƒœë¡œ ê²°ê³¼ë¥¼ ë°˜í™˜í•´ì¤˜:

[
  {{
    "day": "DAY 1",
    "activities": [
      {{
        "time": "09:00",
        "title": "ê²½ë³µê¶",
        "desc": "ì¡°ì„ ì‹œëŒ€ ê¶ê¶ ë°©ë¬¸",
        "from": "í˜¸í…”",
        "to": "ê²½ë³µê¶",
        "moveType": "ì§€í•˜ì² ",
        "duration": "20ë¶„",
        "latitude": 37.5796,
        "longitude": 126.9770
      }},
      ...
    ]
  }},
  ...
]

âš ï¸ ì¡°ê±´:
- ë°˜ë“œì‹œ 'activities' ë°°ì—´ì„ í¬í•¨í•  ê²ƒ (ì ˆëŒ€ null ë˜ëŠ” ë¹ ì§€ë©´ ì•ˆ ë¨)
- ê° í™œë™ì—ëŠ” ë°˜ë“œì‹œ ìœ„ë„(latitude)ì™€ ê²½ë„(longitude)ë¥¼ í¬í•¨í•  ê²ƒ
- ìœ„ì¹˜ê°€ ëª…í™•í•˜ì§€ ì•Šìœ¼ë©´ êµ¬ê¸€ë§µ ê¸°ì¤€ ëŒ€í‘œ ì¢Œí‘œë¥¼ ì„ì˜ë¡œ ì‚½ì…í•´ë„ ê´œì°®ìŒ
- í•˜ë£¨ì— ì•½ 4~6ê°œì˜ activityë¥¼ í¬í•¨í•  ê²ƒ
- 'from', 'to', 'duration', 'latitude', 'longitude'ëŠ” ë°˜ë“œì‹œ í¬í•¨
- ì¶œë ¥ì€ JSON ì™¸ í…ìŠ¤íŠ¸ ì—†ì´ ìˆœìˆ˜ JSONë§Œ ì¶œë ¥
- ëª¨ë“  ì¶œë ¥ ë‚´ìš©(title, desc ë“±)ì€ ë°˜ë“œì‹œ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì¤˜
"""

    try:
        response = client.chat.completions.create(
            model="gpt-3.5-turbo",
            messages=[
                {"role": "system", "content": "ë„ˆëŠ” ì—¬í–‰ ì¼ì • ê¸°íš ì „ë¬¸ê°€ì•¼."},
                {"role": "user", "content": prompt.strip()},
            ],
            temperature=0.7,
        )

        content = response.choices[0].message.content.strip()
        parsed = json.loads(content)

        # ğŸ”§ ì¢Œí‘œ ëˆ„ë½ëœ ê²½ìš° Google Mapsë¡œ ë³´ì™„
        for day in parsed:
            if "activities" in day:
                for activity in day["activities"]:
                    lat = activity.get("latitude")
                    lng = activity.get("longitude")

                    # â˜… ì¢Œí‘œê°€ ì—†ìœ¼ë©´ place_nameì„ ê¸°ì¤€ìœ¼ë¡œ ë³´ì™„ ì‹œë„
                    if not lat or not lng:
                        place_name = f"{city_or_country} {activity.get('to') or activity.get('title')}"
                        lat, lng = get_coordinates(place_name)
                        print(f"[ì¢Œí‘œ ë³´ì™„] {place_name} â†’ lat: {lat}, lng: {lng}")
                        activity["latitude"] = lat
                        activity["longitude"] = lng

                    # â˜… ì—¬ì „íˆ ì—†ë‹¤ë©´ ê¸°ë³¸ ì¢Œí‘œ ê°•ì œ ì‚½ì…
                    if activity["latitude"] is None or activity["longitude"] is None:
                        print(f"[âš ï¸ ê°•ì œ ì¢Œí‘œ ì‚½ì…] {activity.get('title')}")
                        activity["latitude"] = 48.8566
                        activity["longitude"] = 2.3522

                    # â˜… ì¢Œí‘œ í™•ì¸ ë¡œê·¸
                    print(
                        f"ğŸ“ ë§ˆì»¤ ìœ„ì¹˜ í™•ì¸: {activity['title']} â†’ lat: {activity['latitude']}, lng: {activity['longitude']}"
                    )

        return parsed  # âœ… ì¤‘ì²© ì—†ì´ ë‹¨ì¼ JSON ë°°ì—´ ë°˜í™˜

    except Exception as e:
        return {"error": f"âŒ GPT ì˜¤ë¥˜ ë°œìƒ: {str(e)}"}
